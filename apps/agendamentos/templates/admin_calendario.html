{% extends "base_head.html" %}
{% load static %}
{% block page_css %}

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FullCalendar (Core + DayGrid + TimeGrid + Interaction) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">

  <style>
    body { background: #f5f7fa; }
    .card-shadow {
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: none;
    }
    #calendar {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
    }
    .fc .fc-toolbar-title {
      font-size: 1.15rem;
      font-weight: 700;
    }
    .fc .fc-button {
      border-radius: 10px;
      padding: .45rem .7rem;
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display:inline-block; margin-right: 6px;
    }
  </style>
</head>

{% endblock %}
{% include 'includes/cssdefault.html' %}
{% block title %} Agenda - Calendário {% endblock %}
{% block body %}

{% include "includes/header.html" %}
{% include "includes/nav.html" %}
 {% include "includes/tos.html" %}


<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-11">

        <div class="card card-shadow">
          <div class="card-body p-4 p-md-5">

            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
              <div>
                <h1 class="h4 fw-bold mb-1">Agenda (Administrador)</h1>
                <div class="text-muted">Visualize os agendamentos por dia e hora.</div>
              </div>

              <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="text-muted small">
                  <span class="legend-dot" style="background:#0d6efd"></span>Agendado
                </span>
                <span class="text-muted small">
                  <span class="legend-dot" style="background:#198754"></span>Concluído
                </span>
                <span class="text-muted small">
                  <span class="legend-dot" style="background:#dc3545"></span>Cancelado
                </span>
              </div>
            </div>

            <div id="calendar"></div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal de detalhes -->
  <div class="modal fade" id="eventoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventoModalTitle">Detalhes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><span class="text-muted">Serviço:</span> <strong id="mServico"></strong></div>
          <div class="mb-2"><span class="text-muted">Placa:</span> <strong id="mPlaca"></strong></div>
          <div class="mb-2"><span class="text-muted">Início:</span> <strong id="mInicio"></strong></div>
          <div class="mb-2"><span class="text-muted">Fim:</span> <strong id="mFim"></strong></div>
          <div class="mb-2"><span class="text-muted">Status:</span> <span class="badge" id="mStatus"></span></div>
          <div class="mb-2" id="mValorWrap" style="display:none;">
            <span class="text-muted">Valor:</span> <strong id="mValor"></strong>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FullCalendar JS (Global build) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const modalEl = document.getElementById('eventoModal');
      const modal = new bootstrap.Modal(modalEl);

      function badgeByStatus(status) {
        // ajuste conforme seus choices
        if (status === 'scheduled') return ['Agendado', 'text-bg-primary'];
        if (status === 'completed') return ['Concluído', 'text-bg-success'];
        if (status === 'canceled') return ['Cancelado', 'text-bg-danger'];
        return [status, 'text-bg-secondary'];
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        timeZone: 'local',

        initialView: 'timeGridWeek',  // estilo Google Calendar (semana com horas)
        nowIndicator: true,
        height: 'auto',

        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        slotDuration: '00:15:00',
        expandRows: true,
        firstDay: 1, // segunda

        // ✅ Carrega eventos do endpoint Django
        events: {
          url: "{% url 'agendamentos:eventos_agendamentos' %}",
          method: 'GET',
          failure: function () {
            alert('Falha ao carregar agendamentos.');
          }
        },

        eventClick: function(info) {
          const props = info.event.extendedProps || {};

          document.getElementById('eventoModalTitle').textContent = info.event.title;
          document.getElementById('mServico').textContent = props.servico || '';
          document.getElementById('mPlaca').textContent = props.placa || '';
          document.getElementById('mInicio').textContent = props.inicio || '';
          document.getElementById('mFim').textContent = props.fim || '';

          const [text, cls] = badgeByStatus(props.status);
          const statusEl = document.getElementById('mStatus');
          statusEl.textContent = text;
          statusEl.className = 'badge ' + cls;

          const valorWrap = document.getElementById('mValorWrap');
          const valorEl = document.getElementById('mValor');
          if (props.valor) {
            valorEl.textContent = `R$ ${props.valor}`;
            valorWrap.style.display = 'block';
          } else {
            valorWrap.style.display = 'none';
          }

          modal.show();
        }
      });

      calendar.render();
    });
  </script>
</body>
{% endblock %}
</html>